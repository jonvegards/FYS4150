e_var100 = [4.44071, 4.41601, 4.60681, 4.80239, 5.03183, 5.40081, 5.50442, 5.80788, 6.08185, 6.45361, 7.02942, 7.33624, 7.69243, 8.56567, 8.98515, 10.1885, 11.4666, 12.4718, 12.5706, 11.9861, 10.8073, 9.81194, 9.10693, 8.19381, 7.91946, 7.63205, 7.32048, 6.98433, 6.77534, 6.6245, 6.48845, 6.33738, 6.15385, 6.09307, 5.96519, 5.84133, 5.724, 5.64038, 5.55259, 5.46475, ];
m_var100 = [6.68685, 2.22476, 2.49746, 2.93788, 3.29132, 5.2333, 4.44651, 5.20656, 6.538, 8.4506, 14.1256, 14.2817, 16.9297, 34.087, 38.2753, 81.551, 157.578, 216.061, 296.399, 345.808, 320.802, 278.697, 227.866, 170.896, 151.966, 126.995, 100.316, 79.8638, 73.4892, 62.2318, 55.5243, 51.5489, 42.801, 39.8522, 36.2713, 33.0053, 30.1275, 27.5239, 26.2461, 23.7731, ];
mean_mag100 = [0.86167, 0.856366, 0.850586, 0.843716, 0.836914, 0.834434, 0.826136, 0.817702, 0.807567, 0.796329, 0.798717, 0.784985, 0.769283, 0.747912, 0.727407, 0.674173, 0.624719, 0.567134, 0.490887, 0.405312, 0.333952, 0.276523, 0.231844, 0.187697, 0.175448, 0.158138, 0.139344, 0.123226, 0.117584, 0.107152, 0.101054, 0.0963852, 0.0880155, 0.0843701, 0.0805319, 0.0769025, 0.0732396, 0.0700424, 0.0685223, 0.0651394, ];
%avg_en100 = 

e_var80 = [4.32786, 4.44959, 4.63636, 4.84881, 5.03312, 5.38734, 5.55892, 5.81451, 6.11686, 6.44267, 6.89898, 7.38154, 7.79403, 8.35184, 9.30371, 10.4565, 11.1653, 12.1632, 12.4093, 11.8603, 11.5215, 10.0727, 9.56887, 8.64607, 8.25064, 7.68478, 7.36319, 7.03494, 6.82956, 6.64939, 6.52543, 6.36571, 6.19682, 6.02771, 5.9613, 5.86132, 5.73515, 5.62423, 5.5669, 5.47603, ];
m_var80 = [2.83249, 2.23037, 2.61712, 3.10877, 3.33938, 5.02876, 4.96413, 5.71416, 7.23147, 8.05981, 11.805, 14.5701, 17.9141, 24.3767, 49.4894, 83.6648, 118.33, 171.322, 216.463, 239.046, 240.38, 210.885, 189.779, 161.399, 138.298, 115.877, 99.0965, 80.9592, 72.936, 62.0878, 55.1709, 50.4097, 45.205, 38.445, 36.24, 35.2135, 32.571, 29.6952, 27.3097, 25.4912, ];
mean_mag80 = [0.860122, 0.854743, 0.848435, 0.841555, 0.835183, 0.837323, 0.829422, 0.821031, 0.810788, 0.800055, 0.786199, 0.772097, 0.755693, 0.736957, 0.70786, 0.668135, 0.627664, 0.574341, 0.509441, 0.436757, 0.388055, 0.319173, 0.287464, 0.242592, 0.223983, 0.194511, 0.176919, 0.158803, 0.145281, 0.135475, 0.126612, 0.121577, 0.113611, 0.104687, 0.101651, 0.099432, 0.0952943, 0.0899888, 0.0877768, 0.0839151, ];
%avg_en80 = 

e_var60 = [4.33113, 4.4027, 4.6354, 4.85459, 5.02697, 5.32123, 5.5145, 5.79498, 6.08646, 6.46004, 6.82072, 7.21805, 7.76294, 8.47662, 8.8893, 9.93654, 10.5212, 10.9123, 11.586, 11.6508, 11.0512, 10.4779, 9.89419, 9.40679, 8.40057, 8.12182, 7.63683, 7.31535, 6.90907, 6.84857, 6.59833, 6.34274, 6.19699, 6.12491, 5.9564, 5.85944, 5.73266, 5.66029, 5.5231, 5.45915, ];
m_var60 = [3.52987, 2.24269, 2.60738, 3.09001, 3.26325, 4.71971, 4.4542, 5.53722, 6.69913, 8.097, 10.3544, 12.8936, 19.2052, 29.9399, 33.5516, 57.8994, 79.0951, 84.7235, 120.405, 142.708, 139.882, 144.643, 137.647, 125.899, 109.165, 97.9879, 85.9711, 74.3207, 63.8837, 60.6654, 53.2708, 45.7487, 41.8685, 39.8612, 36.1343, 32.0245, 30.1568, 28.1618, 24.5354, 24.134, ];
mean_mag60 = [0.842685, 0.837827, 0.831094, 0.824247, 0.817905, 0.822503, 0.814594, 0.805257, 0.795954, 0.784855, 0.771693, 0.757121, 0.740613, 0.739034, 0.721967, 0.676921, 0.643115, 0.609082, 0.546811, 0.49354, 0.455941, 0.386054, 0.362661, 0.31843, 0.279198, 0.252553, 0.233427, 0.209491, 0.185789, 0.184511, 0.169405, 0.157212, 0.149128, 0.14291, 0.136514, 0.129411, 0.124459, 0.119003, 0.111283, 0.110699, ];
%avg_en60 = 

e_var40 = [4.28166, 4.43767, 4.64993, 4.82647, 5.00944, 5.34932, 5.61156, 5.83053, 6.09225, 6.44906, 6.8887, 7.17812, 7.71031, 8.16714, 8.68821, 9.35379, 9.71509, 10.0929, 10.3388, 10.652, 10.655, 10.384, 10.0601, 9.83379, 9.29486, 8.94263, 8.26224, 8.01376, 7.56111, 7.36915, 6.95074, 6.75347, 6.43155, 6.20602, 6.13709, 5.9672, 5.8688, 5.72966, 5.61743, 5.55275, ];
m_var40 = [2.26975, 2.26851, 2.83297, 2.97645, 3.29276, 5.27794, 5.44944, 5.69748, 6.75961, 8.65328, 10.9758, 12.9158, 16.7674, 20.3009, 24.8894, 34.1328, 41.8216, 47.5553, 51.2372, 61.5555, 68.8161, 69.1153, 72.0128, 72.1197, 69.1293, 66.3696, 61.7518, 58.1752, 52.84, 49.8432, 44.9225, 42.2082, 37.865, 34.373, 33.3775, 30.1803, 28.56, 26.5181, 25.1505, 23.5909, ];
mean_mag40 = [0.830705, 0.82524, 0.819264, 0.812707, 0.80619, 0.831763, 0.823003, 0.815494, 0.805731, 0.793528, 0.784249, 0.771567, 0.753766, 0.737129, 0.716194, 0.686577, 0.66398, 0.634491, 0.604067, 0.567427, 0.530325, 0.49409, 0.454143, 0.418345, 0.390648, 0.367187, 0.332742, 0.312165, 0.28846, 0.272224, 0.252188, 0.24152, 0.226946, 0.213866, 0.206532, 0.192713, 0.186817, 0.18016, 0.173368, 0.168808, ];
avg_en40 = [-1.66921, -1.65954, -1.64989, -1.63906, -1.62878, -1.56914, -1.5572, -1.54572, -1.53332, -1.51955, -1.57142, -1.55763, -1.54147, -1.52628, -1.50907, -1.48141, -1.46213, -1.44356, -1.42587, -1.40408, -1.39391, -1.37332, -1.35353, -1.33474, -1.31852, -1.29574, -1.27842, -1.26441, -1.25034, -1.23771, -1.20179, -1.19078, -1.17895, -1.16803, -1.15835, -1.16235, -1.15298, -1.14376, -1.13419, -1.12549, ];

e_var20 = [4.25123, 4.44762, 4.6141, 4.75786, 5.0161, 5.24106, 5.43165, 5.64833, 5.92231, 6.13212, 6.48811, 6.80516, 7.04907, 7.28964, 7.58827, 7.87237, 8.12875, 8.30084, 8.53791, 8.66926, 8.83385, 8.85027, 8.89918, 8.95293, 8.86591, 8.84374, 8.83106, 8.63234, 8.51883, 8.25551, 8.04999, 7.91938, 7.74491, 7.51363, 7.26815, 7.07056, 6.86577, 6.67182, 6.46595, 6.38146, ];
m_var20 = [2.45663, 2.87039, 2.99515, 3.18279, 3.6022, 7.32379, 7.3191, 7.84254, 8.78184, 9.32667, 7.30751, 8.3935, 9.04222, 9.90848, 11.3106, 12.1857, 13.6999, 14.3064, 15.7627, 16.6642, 20.4431, 20.5867, 21.6059, 22.3303, 22.7435, 21.3367, 21.7302, 21.6455, 21.6497, 21.7445, 21.2545, 20.9938, 20.6189, 20.1914, 19.6257, 19.0858, 18.5568, 18.1097, 17.3614, 16.9321, ];
mean_mag20 = [0.855115, 0.858948, 0.864149, 0.863077, 0.830031, 0.830992, 0.799173, 0.84957, 0.815838, 0.812116, 0.788263, 0.784106, 0.767248, 0.746347, 0.73985, 0.720612, 0.708797, 0.694101, 0.675105, 0.654932, 0.64184, 0.61741, 0.603424, 0.58434, 0.565694, 0.544513, 0.526762, 0.508112, 0.492106, 0.467084, 0.450145, 0.436418, 0.421065, 0.404214, 0.39067, 0.380053, 0.36303, 0.351074, 0.340245, 0.329859, ];
avg_en20 = [-1.67224, -1.66214, -1.65211, -1.64237, -1.63091, -1.54981, -1.53846, -1.52814, -1.51465, -1.50267, -1.50865, -1.49363, -1.4805, -1.46674, -1.45083, -1.53534, -1.51896, -1.50473, -1.48745, -1.47084, -1.45276, -1.43753, -1.4218, -1.40562, -1.38881, -1.33218, -1.31647, -1.30166, -1.28607, -1.26931, -1.24537, -1.23317, -1.21979, -1.20587, -1.19326, -1.26268, -1.24911, -1.23844, -1.22785, -1.21779, ];

temperatures = [2.1, 2.11, 2.12, 2.13, 2.14, 2.15, 2.16, 2.17, 2.18, 2.19, 2.2, 2.21, 2.22, 2.23, 2.24, 2.25, 2.26, 2.27, 2.28, 2.29, 2.3, 2.31, 2.32, 2.33, 2.34, 2.35, 2.36, 2.37, 2.38, 2.39, 2.4, 2.41, 2.42, 2.43, 2.44, 2.45, 2.46, 2.47, 2.48, 2.49, ];
figure(10)
plot(temperatures, e40)
e_var60 = e_var60./temperatures.^2;
e_var40 = e_var40./temperatures.^2;
e_var100 = e_var100./temperatures.^2;
e_var20 = e_var20./temperatures.^2;
e_var80 = e_var80./temperatures.^2;
m_var80 = m_var80./temperatures;
m_var20 = m_var20./temperatures;
m_var60 = m_var60./temperatures;
m_var40 = m_var40./temperatures;
m_var100 = m_var100./temperatures;

[maks_chi_L100, i100] = max(e_var100);
t_c = temperatures(i100);
[maks_chi_L80, i80] = max(e_var80);
t_c = temperatures(i80);
[maks_chi_L60, i60] = max(e_var60);
t_c = temperatures(i60);
[maks_chi_L40, i40] = max(e_var40);
t_c = temperatures(i40)
[maks_chi_L20, i20] = max(e_var20);
t_c = temperatures(i20);

figure(1)
plot(temperatures,m_var20,temperatures, m_var40,temperatures,m_var60,temperatures, m_var80,temperatures, m_var100)
legend('L=20','L=40','L=60','L=80','L=100')
title('\chi(T), \Delta T = 0.01, MC = 1e6','FontSize',16)
xlabel('T','FontSize',16)
ylabel('\chi','FontSize',16)
set(0, 'DefaultAxesFontSize',15)

figure(2)
plot(temperatures,e_var20,temperatures, e_var40,temperatures,e_var60,temperatures, e_var80,temperatures, e_var100)
legend('L=20','L=40','L=60','L=80','L=100')
title('C_V(T), \Delta T=0.01, MC = 1e6','FontSize',16)
xlabel('T','FontSize',16)
ylabel('C_V','FontSize',16)

figure(3)
plot(temperatures,avg_en20,temperatures, avg_en40)%,temperatures,avg_en60,temperatures, avg_en80,temperatures, avg_en100)
%legend('L=20','L=40','L=60','L=80','L=100')
title('$$\bar E(T)$, \Delta T=0.01, MC = 1e6','FontSize',16)
xlabel('T','FontSize',16)
ylabel('\bar E','FontSize',16)



%% Estimating T_c

t_c_est = [temperatures(i20),temperatures(i40), temperatures(i60), temperatures(i80), temperatures(i100)];
L = [20,40,60,80,100];
Linv = [1/20,1/40,1/60,1/80,1/100];

a1 = (temperatures(i100) - temperatures(i80)) / (Linv(5) - Linv(4));
a2 = (temperatures(i100) - temperatures(i60)) / (Linv(5) - Linv(3));
a3 = (temperatures(i100) - temperatures(i40)) / (Linv(5) - Linv(2));
a4 = (temperatures(i100) - temperatures(i20)) / (Linv(5) - Linv(1));
a5 = (temperatures(i80) - temperatures(i100)) / (Linv(4) - Linv(5));
a6 = (temperatures(i80) - temperatures(i60)) / (Linv(4) - Linv(3));
a7 = (temperatures(i80) - temperatures(i40)) / (Linv(4) - Linv(2));
a8 = (temperatures(i80) - temperatures(i20)) / (Linv(4) - Linv(1));


a = (a1+a2+a3+a4+a5+a6+a7+a8)/8

T_C = polyfit(L, t_c_est - a*Linv,1)

%% Plotting analytical and numerical mean magnetization
analytical_temp = linspace(2.1,2.26918531421,100);
analytical_m = zeros(1,length(analytical_temp));

for i=1:length(analytical_temp)
    analytical_m(1,i) = (1 - (sinh(2/analytical_temp(i)))^(-4) )^(1/8);
end
figure(7)
plot(temperatures,mean_mag20,temperatures, mean_mag40,temperatures,mean_mag60,temperatures, mean_mag80,temperatures, mean_mag100, analytical_temp, analytical_m)
legend('L=20','L=40','L=60','L=80','L=100', 'Analytical')
title('\langle |M|(T) \rangle, \Delta T=0.01, MC = 1e6','FontSize',16)
xlabel('T','FontSize',16)
ylabel('C_V','FontSize',16)